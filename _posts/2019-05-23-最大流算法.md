---
categories: algorithm
layout: post
---

- Table
{:toc}

# 一些网络流问题

## 无源汇有上下界可行流

**题目：给定$n$个点和$m$条边组成的图$G$，每条边都有一个流量上限和下限，求一种流量方案，使得每个顶点流量平衡且每条边的流量都合法。**

首先我们让图上跑着一个流$F$，每条边上的流量都是它的下限。这个流如果是不可行的，那么只有一个可能，一些顶点的流量不守恒。我们可以建立另外一张图$G'$，每条边的容量为上限减去下限。由于一些顶点的流量不守恒，我们可以选择释放或追加一些流量来帮助其平衡。做法就是加入一个新的源点和汇点，之后对于每一条边$(u,v)$，我们建立一条从源点到$v$的边，同时建立一条从$u$到汇点的边，容量均为$(u,v)$的下限。

在图$G'$上跑出最大流$F'$后，我们检查每个与源点和汇点相连的边是否被跑满了流，如果不，就无解。因为如果存在可行流，我们将所有边的流量减去下限，这样原图的部分顶点流量就会不守恒，不守恒的部分会借由与源点相连的边或与汇点相连的边流入或流出，这样就能得到跑满的最大流了。

在图$G'$上跑出最大流$F'$后，我们发现$F'+F$是一个可行流，只要删除源点和汇点即可。

LOJ上的[模板题](https://loj.ac/problem/115)

## 有源汇有上下界最大流

**题目：给定$n$个点和$m$条边，其中顶点$1$是源点，顶点$n$是汇点。每条边都有一个流量上限和下限，求一种流量最大的方案，使得每个顶点流量平衡且每条边的流量都合法。**

首先我们跑出一个可行流。但是这里与无源汇有上下界可行流优点不同，就是顶点$1$和$n$允许流量不守恒，准确的说$1$允许入流减出流为负数，而$n$允许入流减出流为正数。这里我们可以从$n$到$1$加一条辅助边，边的容量为无穷。这样跑出了可行流后，删除辅助边得到的还是可行流。

接下来我们考虑如何在可行流的基础上找到最大流，如果我们直接在可行流上跑，就会导致一些边的流量低于下限。简单的方式就是我们在图$G'$的残存网络上跑从顶点$1$到顶点$n$的最大流，尽管图上原先加入的源点和汇点会的流量不守恒，但是与它们相连的边的流量是不会改变的，因此可以直接忽略原先的源点和汇点。。

LOJ上的[模板题](https://loj.ac/problem/116)

## 有源汇有上下界最小流

**题目：给定$n$个点和$m$条边，其中顶点$1$是源点，顶点$n$是汇点。每条边都有一个流量上限和下限，求一种流量最小的方案，使得每个顶点流量平衡且每条边的流量都合法。**

首先算出可行流。之后以t为源点，以s为汇点，跑最大流，之后剩下的流量就是最小流。

LOJ上的[模板题](https://loj.ac/problem/117)

# 最小割

从网络流中删除总容量最少的边，使得s所在连通块与t所在连通块不连通，被删除的边集称为最小割。

**最小割最大流定理：最小割的总容量与网络中最大流相等。**

我们要求$s$与$t$最小割，可以通过最大流算法跑出最大流，之后将与$s$连通的顶点集合记作$S$，将与$t$连通的顶点集合记作$T$，这时候$S\cap T=\emptyset$，而所有从$S$到$T$的边都是被割去的边。


# 最大权闭合图

对于一个有向图G=(V,E)，我们称V的一个子集U为闭合图，如果对于所有边$(u,v)\in E$，有$u\in U\Rightarrow v\in U$。

如果每个顶点都有对应的权值，称总权最大的闭合图为最大权闭合图。

我们可以建立一个对应的图$G'=(V',E')$来计算最大权闭合图。我们通过向V中加入两个新结点s，t得到$V'$，即$V'=V+\{s,t\}$。而对于E中的每一条边，我们在G'中建立对应的一条边，但是容量设为无穷。对于每一个结点u，如果w(u)的权大于0，我们则建立一条边(s,u)，容量为w(u)。而如果w(u)为负数，我们就建立一条边(u,t)，容量为-w(u)。如果w(u)为0，那就不用管。

考虑G'中的一个最小割，由于流量最多为所有结点权值之和，因此最小割中的边容量均不可能超过该上界，即原图中的有向边（容量为无穷）不会出现在最小割中。

简单割是指这样的一个割，其中每条边至少有一个端点为s或t。而很显然图G'只有简单割。

最小割将V'划分为两个连通的集合S与T。而$X=S\cap V$一定是一个闭合图，否则就存在这样一条边$(u,v)\in E$，$u\in X$且$v\in V-X$，但是这也说明X与v不连通，即边(u,v)属于最小割，而这与最小割是简单割相悖。

对于任意闭合图X，我们可以选择从G'中删除所有从X到t的边，以及从s到$V-X$中的边，这些边组成的就是最小割，而剩下的$S=X+s$。

我们记$A=S-s$，$B=T-t$，记$A^+$表示A中所有权重大于等于0的结点集合，而$A^-$表示A中所有权重小于0的结点集合，对于B同样。

由于简单割覆盖了所有S到t的边，以及s到T的边，因此简单割应该满足$cut(G')=B^++(-A^-)$，这里表示的集合中所有结点的权值之和。

而图A的权值之和应该为满足下面性质：


$$
A=A^++A^-=A^++B^+-(B^+-A^-)=V^+-cut(G')
$$



这里$A^+$表示的是集合$A^+$的总权值，其它类似。当A的总权值最大时，显然$cut(G')$最小，因此我们只需要计算出图G'的最小割之后代入上面公式即可得到闭图的最大权，而闭图此时为$S-s$。

提供一道Atcoder的[题目](https://atcoder.jp/contests/arc085/tasks/arc085_c)。



# 最大密度图

假设有图G=(V,E)，要求找其中一个子图G'=(V',E')，使得边数与顶点数的比值尽可能大：

$$
maximize\phantom{1}\frac{|E'|}{|V'|}
$$
符合上述条件的图称为最大密度图。

由于是分数最大化，且分母始终大于0，很容易想到分数规划。分数规划通过不断解决下面过程来二分搜索最终的结果：


$$
h(c)=max\{|E'|-c|V'|\Big|G'=(V',E')\subseteq G\}
$$


要解决上面的问题，我们可以创建一个新图，为G中每个结点和边都在新图中建立一个对应结点，边对应的结点的权值为1，而结点对应的结点的权值为-c。由于选择某条边加入G'的前提是边的两个端点都已经加入了G'，因此我们需要在新图中建立对应的依赖关系，从边对应的结点向其端点添加一条单向边。到此，求解$h(c)$的问题已经转换成了最大权闭合图问题。

由于对于任意两个密度不同的子图$A=(V_A,E_A)$和B=(V_B,E_B)，不妨设图A的密度大于图B。那么有


$$
\frac{|E_A|}{|V_A|}-\frac{|E_B|}{|V_B|}=\frac{|E_A||V_B|-|E_B||V_A|}{|V_A||V_B|}\geq \frac{1}{|V_A||V_B|}\geq \frac{1}{|V|^2}
$$


因此我们二分的精度可以设为$\frac{1}{\|V\|^2}$，二分的上界为$\|E\|$，而二分的下界为$0$，总共二分次数为:


$$
\log_2{\frac{|E|-0}{\frac{1}{|V|^2}}}=O(\log_2|V|)
$$

# 最小费用最大流

每次沿着费用最小的路增广得到的最大流就是最小费用最大流。随着不断增广，最小费用路径的费用和会越来越大。

目前所有通过最小费用路径增广的算法都不具有多项式时间复杂度，其时间复杂度与最大的流量相关联。Codeforces上有相关的[讨论](https://codeforces.com/blog/entry/70740)。

## Dijkstra算法优化最小费用最大流

通过最小费用路径增广最小费用最大流算法，一般采用的都是Spfa搜最小费用路径，这样的话时间复杂度应该为$O(VEf)$，其中$f$是最大流。

但是事实上我们可以利用与Johnson算法类似的思想，将所有边权全部修正为非负。

具体做法是这样的，我们先对原始网络跑出没个顶点从源点出发的最短距离（第一次利用Spfa算法跑），之后修正边$(u,v)$的权重为$W(u,v)+D(u)-D(v)$，由最短路的性质知道$D(u)+W(u,v)\geq D(v)$，很显然此时的图中不存在负权边。

现在考虑增广了流后残存网络的变化：新的边加入以及旧的边被删除。

考虑新的边$(v,u)$被加入，这意味着$(u,v)$在该次增广时处于最短路径上，那么就一定有$D(v)=D(u)+W(u,v)$，而$(v,u)$的权重将被修正为$W(v,u)+D(v)-D(u)=0$，即没有负权边加入。

旧的边被删除并不会破坏图中无负权边的性质，可以不用考虑。

因此总的时间复杂度为$O(f(V+E)\log_2V)$，不管咋说，都要比Spfa的版本的好。

# 最小割树(Gomory-Hu Tree)

强烈推荐一发[大佬的博客](https://www.cnblogs.com/birchtree/p/10761585.html)，我也是看这篇博客学会的。

下面讲一下自己的理解。

假设给定一个拥有$n$个顶点$m$条边的连通无向图$G=(V,E)$，每条边有一个边权，而图上的从$s$到$t$的割就是$E$的一个子集$E'$，使得从$G$中删除所有$E'$的边后，那么$s$与$t$就不再连通。而所有割中割去的边的总权值最小的称为最小割。网络流中证明了最小割恒等于最大流。这里我们记$F(s,t)$表示$(s,t)$的最小割的权值之和。

而$G$的最小割树是一颗拥有$n$个顶点的树$T$，对于$T$的所有边$(u,v)$，一定满足$(u,v)$的权值等于$F(u,v)$，并且从树中删除边$(u,v)$得到的两个连通块，包含$u$的连通块中的顶点集合恰好是$G$删除最小割后，与$u$保持连通的顶点集合，而包含$v$的连通块中的顶点集合恰好是$G$删除最小割后，与$v$保持连通的顶点集合。

很显然我们可以递归构建这样的一颗最小割树，任意选择当前顶点集合中两个不同顶点$u,v$，之后求出最小割$F(u,v)$，往$T$中加入一条边，之后将与$u$保持连通的顶点集合和与$v$保持连通的顶点集合分别递归处理。总的时间复杂度为$O(n^2+nU)$，其中$U$是每次求图$G$最大流的时间复杂度。

下面我们来证明一个重要的一些命题：

**命题1：对于最小割树上的两条边$(a,b)$和$(b,c)$，一定满足$F(a,c)\leq \min(F(a,b),F(b,c))$**。

证明：

这是很显然的，由于从图$G$移除$a$到$b$的最小割后，$c$落在了$b$连通块中，那么一定有$c$与$a$不连通，换句话说，就是$a$到$b$的最小割同时也是$c$与$a$的一个割，由此得到$F(a,c)\leq F(a,b)$，同理可以得到$F(a,c)\leq F(b,c)$。

**命题2：对于最小割树上的两条边$(a,b)$和$(b,c)$，一定满足$F(a,c)\geq \min(F(a,b),F(b,c))$**。

证明：

考虑从图$G$删除$a$与$c$的最小割后，不失一般性假设$b$与$c$连通。那么由于$c$与$b$不连通，因此可以断定$a$与$b$也不连通，即$a$与$c$的最小割同时也是一个$a$与$b$的割，因此可以推出$F(a,c)\geq F(a,b)$。当然如果$b$与$a$连通，那么我们则可以推出$F(a,c)\geq F(b,c)$。

**命题4：对于最小割树上的两条边$(a,b)$和$(b,c)$，一定满足$F(a,c)= \min(F(a,b),F(b,c))$**

证明：

结合命题1和命题2可以直接得出。

**命题5：任意两点$u,v$的最小割$F(u,v)$一定等于最小割树上$u$到$v$的唯一路径中权重最小的边的权重（即最小瓶颈边）**

证明：

可以根据树上路径的长度进行归纳法证明。

提供一道BZOJ[题目](https://www.lydsy.com/JudgeOnline/problem.php?id=4519)。

不过说句实话，因为最小割的时间复杂为$O(n^2+nU)$，而你对所有顶点对直接跑最小割的时间复杂度也只是$O(n^2U)$而已，因此除非遇到非常多的最小割请求，否则最小割树并不是多好的选择。

# 参考文献

- [https://www.cnblogs.com/birchtree/p/10761585.html](https://www.cnblogs.com/birchtree/p/10761585.html)