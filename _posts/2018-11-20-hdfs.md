---
categories: tool
layout: post
---

# 概述

## 引言

Hadoop分布式文件系统（HDFS）被设计为适合运行在通用硬件上的分布式文件系统。HDFS是一个高度容错的系统，适合部署在廉价机器上。HDFS能提供高吞吐量的数据访问，非常适合大规模数据集上的应用。

## 大规模数据集

运行在HDFS上的应用具有很大的数据集。HDFS上的一个典型文件大小一般在G字节到T字节之间。

## 流式数据访问

运行在HDFS上的应用和普通应用不同，需要流式访问它们的数据集。HDFS的设计中更多考虑了数据的批处理，而不是用户交互处理。比之数据访问的低延迟问题，更关键的是在于数据访问的高吞吐量。POSIX标准对于HDFS应用的系统不是必须的，为了提高数据的吞吐量，在一些关键方面对POSIX的语义做了一些修改。

## 简单的一致性模型

HDFS应用需要一个一次写入多次读取的文件访问模型，一个文件经过创建写入和关闭之后就不需要改变。这一假设简化了数据一致性问题，并且使高吞吐量的数据访问成为可能。

## 移动计算比移动数据更划算

一个应用请求的计算，理它的操作数据越近就越高效，在数据达到海量级别的时候尤其如此。HDFS为应用提供了将它们自己移动到数据附件的接口。

## Namenode和Datanode

HDFS采用master/slave架构。一个HDFS集群由一个Namenode和若干个Datanodes组成。Namenode是一个中心服务器，负责管理文件系统的名字空间以及客户端对文件的访问。集群中的Datanode一般是一个结点一个，负责管理它所在结点上的存储，HDFS暴露了文件系统的命名空间，用户能够以文件的形式在上面存储数据。从内部来看，一个文件事实上被分成若干个数据块，这些块存储在一组Datanode上，Namenode执行文件系统的名字空间操作，比如打开，关闭，重命名文件或目录，它也确定了数据库到具体Datanode的映射。Datanode负责处理文件系统客户端的读写请求，在Namenode的统一调度下进行数据块的创建、删除和复制。

集群中单一Namenode的结构大大简化了系统的架构，Namenode是所有HDFS元数据的管理者，用户数据永远不会流过Namenode。

## 文件系统的名字空间

HDFS支持传统的层次文件组织结构，用户或应用程序可以创建目录，然后将文件保存在这些目录中，文件系统名字空间的层次结构和大多数现有的文件系统类似：用户可以创建、删除、移动和重命名文件。

Namenode负责维护文件的名字空间，任何对文件系统名字空间或属性的修改都将被Namenode记录下来。应用程序可以设置HDFS保存的文件的副本数目。文件副本的数目称为文件的副本系数，这个信息也是由Namenode保存的。

## 数据复制

HDFS被设计为能够在一个大集群中跨机器可靠地存储超大文件。它将每个文件存储成一系列数据块，除了最后一个，所有的数据块都是同样大小的。为了容错，文件的所有数据块都会有副本，每个文件的数据块大小和副本系数都是可以配置的。应用程序可以指定某个文件的副本数目，副本系数可以在文件创建的时候指定，也可以在之后改变。HDFS的文件都是一次性写入的，并且严格要求在任何时候只能由一个写入者。

Namenode全权管理数据块的复制，它周期性地从集群中的每个Datanode接收心跳信号和块状态报告。接受到心跳信号就意味着该Datanode结点存活。块状态报告包含了一个该Datanode上所有数据块的列表。

## 副本存放

副本的存放是HDFS可靠性和性能的关键。优化的副本存放策略是HDFS区分于其他大部分分布式文件系统的重要特性。HDFS采用一种称为机架感知（rackaware）的策略来改进数据的可靠性、可用性和网络带宽的利用率。

大型HDFS实例一般运行在跨越多个机架的计算机组成的集群上，不同机架上的两台机器之前的通讯需要经过交换机。在大多数情况下，同一机架上的两台机器的带宽会比不同机架的两台机器间的带宽大。

通过一个机架感知的过程，Namenode可以确定每个Datanode所属的机架ID。一个简单但没有优化的策略就是将副本存放在不同的机架上。这样可以有效防止当整个机架失效时数据的丢失，并且允许读数据时充分利用多个机架的带宽，这种策略设置可以将副本均匀地分布在集群上，有利于当组件失效情况下的负载均衡。但是，因为这种策略的一个写操作需要传输数据到多个机架，这增加了写代价。

在大多数情况下，副本系数时3，HDFS的存放策略时将一个副本保存在本地机架结点上，一个副本放在同一机架的另外一个结点上，最后一个副本放在不同机架的结点上。这种策略减少了机架的数据传输，这就提高了写操作的效率。机架的错误远远比结点的错误少，所以这个策略不会影响到数据的可靠性和可用性。于此同时，因为数据块只放在两个不同的机架上，所以此策略减少了读取数据时所需的网络传输总带宽。这种策略下，副本并不是均匀分布在不同的机架上。三分之一的副本在一个结点上，三分之二的副本在一个机架上，其他副本均匀分布在剩下的机架上。

## 副本选择

为了降低整体的带宽消耗和读取延时，HDFS会尽量让读取程序读取离它最近的副本。如果在读取程序的同一个机架上由一个副本，那么就读取该副本。如果一个HDFS集群跨越多个数据中心，那么客户端将首先读取本地数据中心的副本。

## 安全模式

Namenode启动后会进入一个称为安全模式的特殊状态。处于安全模式的Namenode是不会进行数据块的复制的。Namenode从所有的Datanode接受心跳信号和块状态报告。块状态报告包括了某个Datanode所有的数据块列表。每个数据块都哦有一个指定的最小副本书，当Namenode检测确定某个数据块的副本数目达到这个最小值，那么该数据块就会被认为是副本安全的；在一定百分比的数据块被Namenode检测确认是安全之后（加上一个额外的30秒的等待时间），Namenode将退出安全模式状态。接下来它会确定还有哪些数据块的副本没有达到指定数目，并将这些数据库复制到其他Datanode上。