---
categories: algorithm
layout: post
---

- Table
{:toc}

# 基础概念

一个图G=(V,E)，如果V可以分为两个不相交集合L、R，使得$L\cup R=V$且$L\cap R=\emptyset$。且集合L中任意两个顶点之间没有边存在，集合R中任意两个顶点之间没有边存在，那么称图G为二分图。





我们将V分成若干个子集$X_1,X_2,\ldots,X_k$，其中每个子集都对应G中的一条无环路径，且所有子集的并集为V，那么称顶点子集族${X_1,X_2,\ldots,X_k}$为G的路径覆盖。最小的路径覆盖称为最小路径覆盖。如果所有子集彼此之间交集为空，那么称子集族为G的不相交路径覆盖，否则称为相交路径覆盖。

# Berge定理

**定理：图G的匹配M是最大匹配的充分必要条件是G中不存在M可扩展路。**

证明：

必要性：

如果存在可扩展路，我们可以将可扩展路上的原本选中的边剔除出M，并加原本未选中的边加入M，从而我们的M的基数增大了1。

充分性：

设M不是最大匹配，且M中不存在可扩展路。设M'为最大匹配。那么记新的匹配$H=M\oplus M'=M\cup M' - M\cap M'$。此时H中被匹配顶点的度数非1即2（被M或M'匹配），H中任意连通分支必然是仅来自M中的边和仅来自M'中的边形成的交替路。如果有环出现，那么环一定是偶环，我们可以将其缩为一个顶点。考虑到$\|M'\|>\|M\|$，因此H中来自M'的边一定多于来自M的边，这意味着在H中必定存在一个连通分支，其对应长度为奇数的一条路径，并且最两端的边均来自M'。这样我们就找到了一条可扩展路。



Berge定理为我们提供了一种寻找最大匹配的方法。

# 最大流算法求最大匹配

对于E的一个子集，若子集中的任意两条边都没有公共顶点，那么称该子集为图G的一个匹配。如果不存在比某个匹配更大的匹配，则称该匹配为G的最大匹配。

我们向图中加入两个顶点s，t，分别作为源点和终点，从s到所有L中顶点建立一条容量为1的边，从R中所有顶点到t建立一条容量为1的边。之后在图上跑最大流算法就可以得到最大覆盖了，一个边如果流量为1，则边为最大匹配的一部分。

很显然这样得到的一组边集是一个匹配，而对于任意一个匹配，匹配中的每一条边都能为最大流算法提供1的流量。因此最大流算法得出的最大流与最大覆盖的大小等同，而我们得到的边集的大小等同于最大流的大小，因此该覆盖是最大匹配。

# Dinic求最大匹配

Dinic的思路是通过BFS得到图的分层，之后增广到无法继续增广。

**命题：用Dinic求最大匹配的时间复杂度为$O(m\sqrt{n})$，其中n是顶点数目，m是边数目。**

证明：

每次分层加增广的时间复杂度为$O(m)$。考虑经过$\sqrt{n}$次增广后，那么图中最短增广路的长度至少为$\sqrt{n}$，这是因为每次分层后最短增广路严格递增。

假设M是当前得到的匹配，而M‘是最大匹配，那么考虑$M\oplus M'=M\cup M' - M\cap M'$。其中的每个强连通分量要么是偶环，要么是长度大于$\sqrt{n}$的交替路，因此最多有$n/\sqrt{n}=\sqrt{n}$条增广路可以继续增广，即之后最多还有$\sqrt{n}$次分层，总的分层次数不会超过$2\sqrt{n}$，总的时间复杂度为$O(m\sqrt{n})$。

# Kuhn-Munkres算法

Knhn-Munkres也是一个求最大匹配的算法，时间复杂度与EK算法类似，同样是$O(E(V+E))$，但是由于是二分图专用的，因此实际效果非常好，个人实测有将近10倍的差距。

算法的思路与EK算法类似，也是沿着残存网络中的边进行增广。

```java
/**
* 要求node释放自己的同伴，成功返回true，失败false
*/
boolean release(Node node){
    if(node.visited)
    {
        return false;
    }
    node.visited = true;
    if(node.partner != null && bind(node.partner))
    {
        node.partner = null;
    }
    return node.partner == null;
}
/**
* 要求node重新寻找一个新的同伴，成功返回true，失败false
*/
boolean bind(Node node)
{
    if(node.visited)
    {
        return false;
    }
    node.visited = true;
    for(Node nearby : node.edges)
    {
        if(!release(nearby))
        {
            continue;
        }
        node.partner = nearby;
        nearby.partner = node;
        return true;
    }
    return false;
}
```

# 最小顶点覆盖

对于V的一个子集，若对于任意E中的一条边，其至少一个顶点属于该子集，那么称该子集为图G的一个顶点覆盖。所有顶点覆盖中最小的顶点覆盖，称为图G的最小顶点覆盖。



**Konig定理：二分图中的最大匹配数等于这个图的最小顶点覆盖数。**

证明：

假设我们找到了最大匹配Y。

我们称Y中所有边的两个端点为被Y所匹配。我们遍历所有R中没有被Y匹配的顶点，寻找所有长度为偶数的路径，路径中匹配边和未匹配边交替出现。事实上不存在长度为奇数的路径，不然我们就找到了一个增广路径。我们将L中被标记过的顶点和R中未被标记的顶点合成一个新的点集合X，我们接下来证明X是最小顶点覆盖。

首先先说明X是顶点覆盖，即所有边至少有一个端点属于X。假设存在一条边e，e的两个端点$l\in L$,$r\in R$均不属于X，这意味着l未被标记而r被标记过了。但是这是不可能的，因为r被标记意味着存在这样一个顶点序列$r_0,l_0,r_1,l_1,\ldots,r$，其中路径$(r_i,l_i) \notin Y$且$(l_i,r_{i+1}) \in Y$。我们可以在路径尾部追加$l$得到更长的一条奇数路径，l必定被Y匹配，因此存在另外一条边$(l,t)\in Y$，即路径$r_0,l_0,r_1,l_1,\ldots,r,l,t$是一条合法路径，其上所有顶点都会被标记，因此不存在这样的边，X是顶点覆盖。

之后说明X最小。显然每个Y中的边至少需要一个顶点覆盖，因此最小顶点覆盖数至少为\|Y\|。我们接下来证明$\|X\|=\|Y\|$。

很显然，X中的顶点必定都被Y所匹配（回忆下X是由哪些顶点组成的）。而如果一条$Y$中的边e，两个端点$l\in L$,$r\in R$都属于X，这意味着l被标记而r未被标记，这是不可能的，因为我们同样可以构建一个合法的标记路径。因此我们知道$Y$中的每一条边只有一个顶点属于$X$，到此，我们证明了$\|X\|=\|Y\|$。

# 最小边覆盖

对于E的一个子集，若对于任意V中的一个顶点v，一定能在子集中找到一个边e，使得v是e的某个端点，那么称该子集是图G的一个边覆盖。所有边覆盖中最小的称为最小边覆盖。

**最小边覆盖数等于$\|V\|-\|Y\|$，其中，其中$Y$是最大匹配。**

证明：

假设X是最小边覆盖，我们可以保证，X中每条边都至少独立覆盖了一个顶点（不然我们可以将这条边删除得到更小的一个边覆盖）。我们不断从X中删除仅独立覆盖一条顶点的边，假设共删除了k个顶点。留下的$\|X\|-k$条边都独立覆盖了两个顶点，可以发现此时条边都独立覆盖了两个顶点，可以发现此时条边都独立覆盖了两个顶点，可以发现此时条边都独立覆盖了两个顶点，可以发现此时X同样也是G的一个匹配。由此得出下面不等式：


$$
2X=V+k\geq V+X-Y\Rightarrow X\geq V-Y
$$



因此我们可以得出最小边覆盖的大小至少为$\|V\|-\|Y\|$。下面我们讲述如何得到最小边覆盖。

记边集X初始为Y。由于X覆盖了2X个顶点，记这些顶点集合为U，我们为每个不属于U的顶点，找到一个以其为端点的边并加入到Y中。完成上述操作后，X的大小正好为$\|V\|-\|Y\|$。此时。此时。此时。此时X为图G的一个边覆盖。

# 二分图最大独立集

对于V的一个子集，若子集中任意两个不同顶点之间都没有边，那么称该子集为G的一个独立集。独立集中最大的称为最大独立集。

**二分图最大独立集的大小等于$\|V\|-\|M\|$，其中M为最大匹配。**

证明：

要计算最大独立集，我们可以换种理解。我们记X为最大独立集，而Y=V-X。要获取最大独立集，我们实际上要从V中移除一些由边连接的顶点。对于任意边的两个端点，我们至少需要从V中移除一个顶点。换言之，每个边的都有至少一个端点属于集合Y。容易发现Y是一个顶点覆盖，同样的任意一个顶点覆盖，其对于V的补集一定也是一个独立集。由于$\|X\|=\|V\|-\|Y\|$，要让X最大，等价于Y最小，因此Y实际上是一个最小顶点覆盖，而我们之前已经讨论过最小顶点覆盖和最大匹配等大，因此公式$\|X\|=\|V\|-\|M\|$。

# 二分图最大团

对于V的一个子集，若子集中任意两个顶点之间都有边，那么称该子集为G的一个团，团中最大的称为最大团。

二分图G=(V,E)中的团，对应G的补图中的一个独立集。而最大团对应的就是补图中的最大独立集，之前已经讨论过最大独立集的求法了，这里不赘述。

# 最小不相交路径覆盖

我们将有向无环图G=(V,E)中每个顶点$v$拆成两个顶点$v_l$,$v_r$，而对于E中每一条边$(u,v)$，我们对应的建立一条边$(u_l,v_r)$。这样我们就建立了一个二分图G'。图G的最小不相交路径覆盖的大小等于$\|V\|-\|M\|$。其中M表示最大匹配。

证明：

在初始的时候对于每个顶点v，我们都可以建立一条不相交路径$(v_l,v_r)$，因此一开始我们可以建立$\|V\|$条不相交路径。

对于任意一个匹配，对于匹配中每一条边$(u_l,v_r)$，我们将以$v_r$结尾的路径与以$u_l$为开端的路径通过$(u_l,v_r)$合并在一起。显然每次合并后，任意一个结点出现且仅出现在一条路径中。因此我们可以得到一个大小为$\|V\|-\|M\|$的路径，我们将其中的$u_l$和$u_r$结点合并为一个结点$u$后就得到了原图G中的一条大小为$\|V\|-\|M\|$的不相交路径覆盖。这里我们证明了最小不相交路径覆盖的大小的上界为$\|V\|-\|M\|$，但是还未证明不存在更小的不相交路径覆盖。

同样的，对于任意一个最小不相交路径覆盖$P$，我们将其中每个顶点$v$拆成两个顶点$v_l$和$v_r$通过边$(v_l,v_r)$相连。之后我们将$P$中所有形如$(u_l, v_r)$的边提出为一个集合$Y$，很显然$Y$是图$G'$的一个匹配（因为任意顶点在$P$中最多出现一次）。而$\|P\|+\|Y\|=\|V\|$，因此$\|P\|\geq \|V\|-\|M\|$。这里证明了最小不相交路径覆盖的大小的下界同样为$\|V\|-\|M\|$。

# 最小相交路径覆盖

对于有向无环图G=(V,E)，如果顶点u到v存在一条路径，则我们向图中加入一条边$(u,v)$，这样我们得到了图$G'$。$G$中的最小相交路径覆盖与$G'$最小非相交路径覆盖是等大的。

证明：

对于图$G'$中的最小非相交路径覆盖$P$，对于P中的任意边$(u,v)$，我们知道$u$和$v$在原图$G$中一定是有路径连接的，我们用路径替换边$(u,v)$，就可以得到$G$中的一条相交路径覆盖。

同样的对于图$G$中的一条相交路径覆盖，我们可以其中的所有重复路径，替换为一条边。之后就能得到图$G'$中的一条不相交路径覆盖。

# 霍尔定理

对于二分图$(A,B)$，存在一种匹配，使得$A$中所有顶点都被匹配，当且仅当对于任意$A$的子集S，记与其相邻的所有顶点的集合为$N(S)$，有$\|S\|\leq \|N(S)\|$。

# 链和反链

对于偏序集S，称S的子集A是链，当且仅当A组成一个全序集。若S的子集B中元素两两不可比较，那么称B是反链。

最小链覆盖是指S的一个子集族，每个元素都是链，所有元素的并为V，但是不同元素的交集为空。同样最小反链覆盖也是S的一个子集族，每个元素都是反链，所有元素的并为V，但是不同元素的交集为空。



**Dilworth定理：偏序集的最小链覆盖大小等于S的最长反链的长度**

证明：

记最小链覆盖的大小为n，最长反链长度为m。

设L是S的一个最长反链，很显然多个L中的元素不能同时属于相同的链，因此最小链覆盖至少包含m个链，即$n\geq m$。

之后利用数学归纳法证明$n\leq m$。

当S的大小为0或1的时候，命题显然成立。

我们记s是S的一个极大元，记S'=S-{s}。由归纳法知，S'的最小链覆盖的大小与最长反链的长度相同，记作k。设S'的最长链覆盖为$\{C_1, C_2, \ldots, C_k\}$，而S'的所有长度为k的反链为$R_1, R_2, \ldots, R_r$。很显然，对于$R_i$，必定是由最长链覆盖中每个集合取一个元素组成的，我们记$R_i$与$C_j$的唯一公共元素为$x_{ij}$。对于$j=1,2,\ldots, k$，记$m_j=\max_i(x_{ij})$。现在考虑集合$M=\{m_1, m_2, \ldots, m_k\}$，如果其中有任意两个不同元素$m_i,m_j$可以比较，不妨设$m_i\leq m_j$，记$m_i$所在的反链为$R_p$，而$m_j$所在的反链为$R_q$，那么可以推出$x_{qj} = M_j \geq x_{pi} = M_i \geq x_{qi}$，即$R_q$包含两个可比较元素，这是不可能的，因此我们知道$M$是反链。

接下来我们考虑集合S，即向S'加入元素s。考虑两种情况：

1) 如果M与s中元素都不可比较，那么我们考虑集合$M\cup \{s\}$，这是一个长度为k+1的反链。而向集合中加入一个元素，最多会增加其最长反链长度1，以及最小链覆盖大小1。因此有$m\geq k+1 \geq n$。

2) 如果M与s中某个元素可以比较，假设s与$M_i$可以比较，设$M_i$所在的反链为$R_j$，那么我们可以推出s大于等于$R_j$中的所有元素，即$D=R_j\cup \{s\}$也是一个链。现在考虑集合S''=S-D，由于S中的所有反链都少了一个元素，因此S''的最长反链的长度为k-1，同样利用归纳法知其最小链覆盖为$\{C'\_1,C'\_2,\ldots, C'\_{k-1} \}$。我们将D加入得到新的最小链覆盖$\{C'\_1,C'\_2,\ldots, C'\_{k-1}, D\}$。因此S的最小链覆盖大小一定是$k$，故可以得到$m\geq k = n$。





**Dilworth对偶定理：偏序集的最小反链覆盖大小等于S的最长链长度**

证明：

记最小反链覆盖的大小为n，最长链长度为m。

设L为S的一个最长链，而L中多个元素肯定不能同时属于一个反链，因此最小反链覆盖至少含有m个反链，即我们推出了$n\geq m$。

我们记$X_1$为S中的极小元的集合，并从S中移除$X_1$的元素。之后继续定义$X_2$为S中极小元的集合，并同样从中移除。重复这个过程，直到S为空，假设过程中我们得到了k个非空集合$X_1,X_2,\ldots, X_k$。极小元的集合一定是S的一个反链，我们得到了一个大小为k的反链覆盖。同样我们从$X_1,X_2,\ldots, X_k$中分别取一个元素$x_1,x_2,\ldots, x_k$，满足$x_1\leq x_2 \leq \ldots \leq x_k$，这样我们就得到了长度为k的一个链。得到关系式$n\geq k \geq m$，结合之前得到的$n\geq m$，可以推出$n=m$。



**求最长反链方法：**

我们先利用最小相交路径覆盖将图建成二分图并求得最大匹配。设n为顶点数，最大匹配数为m，记l(i)表示二分图左侧第i个顶点，r(i)表示二分图右侧第i个顶点。

之后我们可以找到最小顶点覆盖，利用最小顶点覆盖得到最大独立集。对于$1\leq i \leq n$，如果l(i)和r(i)同时属于最大独立集，我们就将它放入到集合A中，集合A初始时为空集。在上述操作后，我们得到的集合A就是最长反链条。

用反证法证明，如果A中任意两个元素u、v可比较，那么不妨设$u\leq v$。这意味着l(u)与r(v)之间有边，而我们知道l(u),r(u),l(v),r(v)都属于最大独立集，因此不可能发生。

现在我们证明得到的反链长度正好为$n-m$。由于二分图共有$2n$个顶点，而最大独立集中有$2n-m$个顶点。$\|最大独立集\|=\|A\|+\|\{i\|l(i)与r(i)有且仅有一个属于最大独立集\}\|$。而后者最多为n，因此推出前者至少为n-m。当然反链长度是不可能超过n-m的，因此得到的反链的长度恰好为n-m。



# HDU1150

**题意**

两台机器A、B，每台机器分别有n和m种模式。k个任务，每个任务可以被机器A以模式x或机器B以模式y处理。每次切换模式，都需要重启机器，问处理完所有任务最少需要重启多少次机器。

**题解**

很容易发现，这是一个二分图问题。一开始，能看出，如果我们以任务作为左边结点，而机器的状态作为右边结点，任务与机器状态的关联转换为边。问如何最少激活右边结点来使得通过网络的流量总共为k。

激活结点的问题看似可以用费用流来解决，比如每个状态与终点连一条边，边上每流量费用为1。但是实际上这个问题不是费用流问题，因为实际上只有第一个单位流的费用为1，后面的流式免费的。

实际上我们将最少激活数看做做少顶点选择数，将A机器的状态作为左边结点，将B机器的状态作为右边结点，每一个任务（i，x，y），建立一条从左边x结点到右边y结点的边。问题就是如何选择最少的顶点集合S，使得边的至少一个端点属于S，这是一个最小顶点覆盖问题，最小顶点覆盖数与最大匹配数是相等的，因此直接上KM算法即可。

# POJ3692

**题意**

有G个女生和B个男生，女生互相认识，男生互相认识，部分男生和女生相互认识。问最多能找到多少人，使得这些人都相互认识。

**题解**

问题实际上求的是二分图的最大团。

# POJ2060

**题意**

有n个订单，我们可以派出车辆去接这些订单。每个订单都有一个截止时间，接客地点，目标地点。一个车辆送客完成后可以去接下一个订单。要求每个订单，都必须有车辆去接。问最少需要多少车辆。

**题解**

问题实际求的是不相交最小路径覆盖。

# BZOJ1854

**题意**

[https://www.lydsy.com/JudgeOnline/problem.php?id=1854](https://www.lydsy.com/JudgeOnline/problem.php?id=1854)

**题解**

一开始想的是二分图匹配，但是数据量太大，会TLE。
可以用并查集，如果一个联通块中存在环，则联通块必定可以全选，否则至少有一个结点可以选。

# AtCoder Grand Contest 037D

**题意**

[https://atcoder.jp/contests/agc037/tasks/agc037_d](https://atcoder.jp/contests/agc037/tasks/agc037_d)

**题解**

为最终处于不同行的元素提供不同的颜色，相同行的元素相同的颜色。问题等价于，重排每一行，使得每一列的元素颜色不同。

我们建立一个n\*n的二分图。

要处理n\*m矩阵，每种颜色恰好出现m次。先考虑第一列，我们希望保证第一列中所有元素颜色不同。如果第i行包含颜色j，那么我们在二分图左边第i个顶点和右边第j个顶点之间连一条边。由霍尔定理知，二分图一定存在完美匹配。我们找到完美匹配，之后重排元素，并忽略第一列。之后我们需要处理n\*(m-1)矩阵，每种颜色恰好出现m-1次，用同样的技术就可以处理。

# LUOGU4298

**题意**

[https://www.luogu.org/problem/P4298](https://www.luogu.org/problem/P4298)

**题解**

首先要理解问题要我们求的是有向无环图的最大独立集。我们将单向边视作偏序关系，那么我们可以将求最大独立集理解为求反链。

利用Dilworth定理得知求反链实际上求的就是最小链覆盖，而最小链覆盖实际上就是最小相交路径覆盖。

# Atcoder jsc2019_qual_e

**题意**

[https://atcoder.jp/contests/jsc2019-qual/tasks/jsc2019_qual_e](https://atcoder.jp/contests/jsc2019-qual/tasks/jsc2019_qual_e)

**题解**

问题要求我们为每一行选取一个卡片，每一列选取一张卡片。下面我们建立一个二分图B，图B的左边顶点表示的是卡片，而右边则为每个行列均建立一个顶点。卡片与所在的行列连一条带权重的边。问题要我们找到最大权的匹配。

我们考虑结果，如果结果中包含卡片$(i,j,a)$，那么卡片要么与第i行连边，要么与第j行连边。我们重新建立一副图G，图中为每个行列建立一个顶点，如果卡片$(i,j,a)$被选择到结果中，那么就将第i行和第j列所代表的顶点加一条边。我们会发现结果是若干个连通分量，每个连通分量要么是树，要么是树上加一条边（只有一个环的连通图），因为一个连通分量m个顶点不能同时分配给m+1条边。

考虑权重最大的卡片$x=(i,j,a)$，容易得知x一定会出现在结果中（如果不出现，可以用x替换与其同行的出现在结果中的卡片），因此在G中行$i$和列$j$之间是始终存在一条边的，这意味着我们可以将二个顶点合并。之后问题的规模就被缩小了，重复这个流程直到所有卡片都被处理完了。

要维护G，用并查集就足够了，加上预先对边排序的时间复杂度，总的时间复杂度为$O(n\log_2n)$。

# LUOGU1263

**题意**

[https://www.luogu.org/problem/P1263](https://www.luogu.org/problem/P1263)

**题解**

比较典型的二分图问题了。

考虑同一行，如果中间有墙隔开，那么我们可以将其拆做两行也不会影响结果。用这种方法我们只给连续的处于同一行的空地（包括陷阱）分配唯一的行号，同理对于连续的处于同一列的空地分配唯一的列号。我们知道每一列最多只能放一个守卫，而每一行也最多只能放一个守卫。建立一副二分图，左边的顶点代表行，右边的顶点代表列，我们将每个空地（行列编号为i、j）当做一条连接左边顶点i和右边顶点j的边加入到二分图中。

这样我们希望尽可能多的守卫被放置，等价于取得二分图最大匹配。

# 参考文献

\[1\] [匹配 wiki介绍](https://zh.wikipedia.org/wiki/%E5%8C%B9%E9%85%8D_(%E5%9B%BE%E8%AE%BA))

\[2\] [Konig定理百度百科](https://baike.baidu.com/item/Konig%E5%AE%9A%E7%90%86)

\[3\] 算法导论

\[4\] [二分图最大匹配的König定理及其证明](http://www.matrix67.com/blog/archives/116)

\[5\] [Dilworth定理证明](https://www.cnblogs.com/itlqs/p/6636222.html)