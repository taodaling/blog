---
categories: algorithm
layout: post
---

- table
{:toc}

# 长链剖分

长链剖分可以用于解决一些树上与高度相关的DP问题。

长链剖分类似于dsu on tree。

首先我们要处理出一颗树中的长链。记Len(x)表示顶点x到以x为根的子树中最深的叶节点的距离。对于任意结点x，设y为x直接子结点中Len最大的（如果有多个最大，则仅选择其中一个），那么我们将x和y之间的边称为长边，由长边组成的路径称为长链。这样操作后，整颗树将包含若干条链，这些链没有公共顶点和公共边，并且每个结点唯一属于一条链。



**性质1：由于没有公共边，所有长链的总长度不超过n。**

**性质2：顶点x的k级祖先y所在链的长度一定不小于k**

证明：

如果x和y处于同一长链，很显然成立。

否则由于x在y的子树中，故Len(y)>=k，因此可知y所在长链一定不小于k。





下面说两种长链的应用。

**用例1：在线查询树上某个结点的k级祖先**

我们可以使用倍增算法找到每个顶点的所有2次幂祖先顶点。之后对于所有长链顶部结点x，为其创建两个两个大小为L=Len(x)-1的数组A、B，其中A保存x上面L个顶点，而B保存x沿着长链向下的L个顶点。之后还需要预先计算1~n中每个数的二进制最高位。上面的所有过程总的时间复杂度为$O(n\log_2n)$，空间复杂度为$O(n\log_2n)$。

之后对于诸如询问询问x的k级祖先，我们用倍增先找到x的$highestBit(k)$级祖先y，之后对于$k'=k-highestBit(k)$，可以推出$k<highestBit(k)$，而我们由性质2得到y所在的长链的长度至少为$O(highestBit(k))$，因此我们可以直接利用y所在长链顶部顶点的A、B数组直接查表得到。



**用例：查询树上距离最远的一对顶点，要求这对顶点之间边数正好为k**

为每个长链顶部顶点创建一个与其所在长链的长度相同的数组，这里总的空间复杂度为$O(n)$。

之后我们处理非顶部顶点x时，我们就复用顶部顶点的预分配的数组，第i个元素记录x子树中由i条边组成总权最大路径的总权。

首先我们先递归处理长边连接的顶点，之后和通过短边连接的顶点的数组合并。

由于只有长链顶部顶点会对父元素产生与其长度相同的贡献，因此时间复杂度为$O(n)$。