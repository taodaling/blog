---
categories: algorithm
layout: post
---

- Table
{:toc}

# 动态规划解决博弈问题

博弈问题是指有两个玩家参与，每个玩家轮流做出决策，最后按照结果判断两个玩家的胜负情况。

如果一个游戏先手必胜，我们称该游戏处于N-position，否则后手必胜，我们称游戏处于P-position。

比如我们可以设计这样一个问题，有一组数，记做$a_1,a_2,\ldots,a_n$，数的总和为奇数。玩家A与B先后轮流决策，每次决策，该名玩家必须从数集中取走最左或最右的数，并从数集中删除。当数取完时，取得的数总和较大的胜利。问两个玩家都做最优决策时，哪个玩家会胜利。

这个问题，就是一个经典的博弈问题，我们可以用动态规划枚举所有可能的状态解决。记$dp(l,r)$表示当数集为$a_l,a_{l+1},\ldots,a_r$时，如果游戏是N-position，记为1，否则为P-position，记为0，可以很容易推出公式：$dp(l,r)=\max(1-dp(l+1,r),1-dp(l,r-1))$。

通过上面的动态规划我们就能以$O(n^2)$的时间复杂度解决博弈问题。如果我们将每个$dp$值视作一个结点，并从$dp(l+1,r)$和$dp(l,r-1)$中向$dp(l,r)$连接一条单向边，就可以构造一幅有向无环图。这幅图，可以清晰展示整个决策流程。

实际上，上面这个博弈问题，有非常简单的解决方案，那就是先手必胜，因为先手可以决定自己选择奇下标的数还是偶下标的数，因此必胜。可以看出虽然动态规划很强大，但是如果能直接给出有用的性质，可以大幅优化时间复杂度。

决策不一定是非胜即负的，比如考虑井字游戏，A持白子，B持黑子，每次可以在一个3\*3表格中的一个空白格子中落子，如果三个白子连成一条直线，则A胜利，游戏结束，如果三个黑子连成一条直线，则B胜利。

很显然，如果双方都最优决策，那么游戏一定是平局的。在上面的这幅图中，这意味着有一部分结点代表着平局，平局的结点仅有向平局和胜利结点的边。

决策图不一定是无环的，比如这样一个游戏。如果A和B各持有两个整数，整数大小为0~9。二人轮流出牌，当A出牌时，将其中一张牌$x$换成$(x+y)%10$，其中y是上次B出的牌（默认A和B之前出的牌为0），对于B同理，只是y是A上次出的牌。当两个玩家手中持有的牌有一张换成0时，就认为该名玩家获得胜利。

很显然还是能通过状态压缩后建立图来解决。但是图中存在环，因此我们需要利用Bellman-Ford算法的松弛技术来完成。而一个结点如果在松弛完后，状态还是无法确定，那么这个结点一定代表平局。

# Nim游戏和Sprague–Grundy函数

用动态规划解决博弈问题，很容易遇到瓶颈，比如状态数过多，无法逐一计算。

考虑Nim游戏，有$n$堆石头，第i堆石头有$a_i$个石头。玩家A、B轮流出手，每次出手，玩家必须选择一堆石头，并从中取走至少一个（最多可以全取）。如果无法完成操作，则认为玩家失败。

很显然，我们可以用动态规划，共$\prod_{i=1}^na_i$种状态，如果有100堆石头，每堆有100个石头，那么状态数将达到$100^{100}$，这显然是无法完成的。

这时候估计大家现在开始纷纷开脑洞，猜测每堆奇偶性会影响胜负等等。

下面说一下正确的解题姿势。

我们之前定义的动态规划函数的值仅为1和0，实际上我们抛弃了很多有用的信息，现在我们把它们加回来。首先所有堆石子为0的结点值为0，保持不变。但是对于其它结点$u$，我们记所有从它出发沿单向边移动一步可以抵达的结点集合为$v_1,v_2,\ldots,v_m$，记$sg(u)=mex(sg(v_1), sg(v_2), \ldots, sg(v_m))$。其中sg为Sprague–Grundy函数。而mex函数值为不同于所有参数的最小非负整数，比如$mex(1,2)=0$，$mex(0,2)=1$。

我们这里提到的Nim游戏，现在可以转换为另外一个问题，我们将每一堆都视作图中的一个棋子，每位玩家都可以选择任意一个棋子沿着有向边移动一步，如果所有棋子都无法移动，那么该名玩家失败。

下面我们讨论两个命题。

**命题1：如果仅一枚棋子，那么游戏处于P-position当且仅当该棋子所在结点的sg值为0**

证明：对于代表失败结果的结点，该棋子没有外向边，sg值显然为0。对于sg值为0的棋子，其所有相连的结点sg值肯定非0，因此其只能移动到N-position，即该结点必定为P-position。而对于sg值非0的棋子，其一定与某个sg值为0的结点相连，因此移动到该结点，游戏进入P-position，因此该结点对应的是N-position。这里证明不是非常严谨，可以换成归纳法进行证明。



**命题2：如果有n个独立棋子，那么游戏处于P-position当且仅当所有棋子所在的sg值的异或和为0**

证明：如果所有棋子都处在代表失败结果的结点，那么它们的sg值异或和自然是$0$。如果异或和为$0$，那么移动一枚棋子，记其原来的sg值为$a$，后来的sg值为$b$，必定有$a\neq b$，故此时异或和一定为$a\oplus b \neq 0$，因此N-position之后一定是P-position。而如果异或和$s$不为0，那么我们一定能找到一个棋子，其所处结点的sg值为$x$，满足x包含s中二进制的最高位，我们将该棋子从所在结点移动到sg值为$s\oplus x < x$的后继结点上，这时候异或和为$s\oplus x\oplus x\oplus x=0$，因此我们在N-position后一定能移动到P-position。配合归纳法可以证明。


这样我们就可以将从n堆石头中移除石头看做为n个独立游戏，而我们只要建立n堆石头各自的决策图，并计算棋子所在结点的sg值的异或和就可以判断游戏的状态了。但是由于Nim游戏中每个独立游戏拥有相同的决策图，因此我们可以复用，事实上，这里我们连决策图都不用建立，剩余n个石子对应的结点的sg值一定是n。

我们考虑到我们仅仅利用了决策图的sg值，与决策图具体代表的游戏是无关的。因此我们可以同时玩多个游戏，只需要利用sg函数就可以快速计算游戏所处的状态。比如我们将Nim游戏稍加变形，操作第i堆石头一次性必须移除1~i个石头。我们可以将每一堆石头建立独立的决策图，并计算每个结点的sg值。之后异或所有决策图上棋子的sg值，为0，则游戏处于P-position，否则处于N-position。

# 棋子分裂

我们稍微修改一下游戏。我们每次并不能移动棋子，但是可以选择一枚棋子，将其分裂为若干颗新的棋子，每个棋子落在特殊的结点上，保证若干步后游戏一定会结束。

这时候我们可以修改每个结点的sg值。在结点$u$上，假设有$k$种分裂策略，第i种分裂策略分裂后棋子分别落在$v_i^1,v_i^2,\ldots$。那么我们定义$sg(u)=mex(v_1^1\oplus v_1^2\oplus \ldots, \ldots, v_k^1\oplus v_k^2\oplus \ldots)$。

稍微修改命题2的证明可以很容易证明游戏处于P-position当且仅当所有棋子所在sg值的异或和为0。