---
categories: algorithm
layout: post
---

- Table
{:toc}

# 随机递增序列

假设有n个未知整数，我们需要$O(C)$的时间复杂度比较一个未知整数和一个已知整数的大小关系，但是要知道某个整数的真实值需要$O(H)$的时间复杂度，而$H$远远大于$C$，可以认为
$$
H\geq C\log_2n
$$
。现在我们想找到这n个整数中最大整数的值。

当然，我们可以直接查询所有未知整数的值，得到最终结果，时间复杂度为$O(nH)$。

我们现在希望能减少时间复杂度。

有一种显然正确的策略，先取第一个数，查出其真实值，作为持有数。之后遍历后面的数，如果这个数比持有数大，将持有数替换为该数。重复这个过程，自然就能找到最大值了，其最坏时间复杂度为$O(n(C+H))=O(nH)$

注意到时间上界是来自于替换的发生，但是事实上，替换不会真的发生n次。如我们对原始的数组进行打乱，我们可以证明一个非常优秀的时间复杂度。

记$f(i)$表示已经检查过$i$个数，后面检查$n-i$个数会发生替换操作次数的期望。那么考虑一个新的数$x$，只有当$x$比我们之前检查过的$i$个数都大的情况下，才会发生替换。因此可以推出期望公式：

$$
f(i)=\frac{1}{i+1}(f(i+1)+1)+\frac{i}{i+1}f(i+1)\\
=f(i+1)+\frac{1}{i+1}
$$

我们要求的是$f(0)$，即检查$n$个数发生的替换总次数的期望，可以推出：

$$
f(0)=f(1)+\frac{1}{1}\\
=f(2)+\frac{1}{1}+\frac{1}{2}\\
\ldots\\
=f(n)+\sum_{i=1}^n\frac{1}{i}\\
=\sum_{i=1}^n\frac{1}{i}\\
\approx \ln n
$$

因此期望的时间复杂度为$O(nC+H\ln n)$

这是非常优秀的时间复杂度。

## 例子1

可以考虑这样一个问题，我们现在有1000份简历，我们需要面试1000个人，并从中找出能力最优秀的候选人。

面试能帮助我们了解应聘人是否比我们已经招募的那个人（通过了试用期）更加优秀。我们可以邀请一个人参加试用，在试用期结束后，我们就能得到这个人的真实能力。

由于岗位有限，同时最多只能有一个人处于试用期。面试一个人，需要一个小时，试用期则长达1个月。问我们最少需要多少时间才能找到最优秀的人。

假如我们每个人都邀请参加试用，那么会需要1000个月，要面到大家都退休。或者我们使用贪心策略，却不保证随机（比如HR按自己的观感将候选人从差到优进行排序），也可能会需要1000个月。

现在我们随机打乱所有的简历，并采用贪心策略，那么我们的所需的期望时间仅仅为1000个小时加上10个月，估摸是一年内可以结束。

# 一些期望计算问题

**问题1：给定n个石头，其处于一条直线上，从左到右的下标分别为$x_1,x_2,\ldots,x_n$，满足$x_1<x_2<\ldots<x_n$。现在我们每次要等概率挑选一个石头（不能选最靠右的那个），将这个石头右移直到碰撞到右边第一个石头，如果碰撞了，那么两个石头就合成了一块石头。重复上面的操作$n-1$次，问所有石头移动的总距离的期望是多少？**

考虑到期望的线性性质，我们可以独立计算第$i$个石头被选择后移动的总距离$d_i$，之后我们要求的就是$E(\sum_{i=1}^{n-1}d_i)=\sum_{i=1}^{n-1}E(d_i)$。考虑第$i$个石头，它停在$x_j$处的概率为$\frac{(j-i-1)!}{(j-i+1)!}$，特殊的停在$x_n$处的概率为$\frac{1}{n-i}$。利用这些性质我们就可以独立求出$E(d_i)$，加总就好了，这样我们的时间复杂度为$O(n^2)$。

但是这个问题实际上并不要求我们算出所有石头移动距离的期望，它要求的只是总期望而已。我们可以拆解$d_i$，记录$t_{i,j}$表示石头$i$在$x_{j-1}$与$x_j$之间通过距离的期望，那么$d_i=\sum_{j=i+1}^nt_{i,j}$。而我们知道$t_{i,j}$仅可能取两个值：$0$或$x_j-x_{j-1}$，其中$P(t_{i,j}=x_j-x_{j-1})=\frac{1}{j-i}$。因此我们重写我们要求的总距离的期望，可以得到：

$$
E(\sum_{i=1}^{n-1}d_i)\\
=E(\sum_{i=1}^{n-1}\sum_{j=i+1}^nt_{i,j})\\
=E(\sum_{j=2}^n\sum_{i=1}^{j-1}t_{i,j})\\
=\sum_{j=2}^n\sum_{i=1}^{j-1}E(t_{i,j})\\
=\sum_{j=2}^n\sum_{i=1}^{j-1}\frac{x_j-x_{j-1}}{j-i}\\
=\sum_{j=2}^n(x_j-x_{j-1})\sum_{i=1}^{j-1}\frac{1}{j-i}\\
=\sum_{j=2}^n(x_j-x_{j-1})\sum_{i=1}^{j-1}\frac{1}{i}\\
$$

注意到右边的$\sum_{i=1}^{j-1}\frac{1}{i}$我们可以线性时间内预处理出来，因此总的时间复杂度可以优化到$O(n)$。

# 一类乘积期望计算问题

**题目1：给定$n$个数，$a_1,\ldots,a_n$，以及另外一组未知变量$b_1,\ldots,b_n$，且已知$\sum_{i=1}^nb_i=m$，位置变量的每一个赋值方案都是等概率的（即总共${n+m-1\choose n-1}$种可能都是等概率的）。现在问$E\[\prod_{i=1}^n(a_i+b_i)\]$。其中$1\leq n,m\leq 10^5$。**

我们可以将期望公式展开开来，记$N=\{1,\ldots,n\}$，得到：

$$
E[\prod_{i=1}^n(a_i+b_i)]=E[\sum_{S\subseteq N}\prod_{i\notin S}a_i\prod_{i\in S}b_i]\\
=\sum_{S\subseteq N}\prod_{i\notin S}a_iE[\prod_{i\in S}b_i]
$$

注意到$E[\prod_{i\in S}b_i]$不取决与$S$，仅取决于$\|S\|$。我们可以记$f(k)=\sum_{S\subseteq N\land \|S\|=k}\prod_{i\in S}a_i$，这个可以通过生成函数在$O(n(\log_2n)^2)$时间复杂度内算出来。那么我们实际上要求的就是：

$$
\sum_{k=0}^nf(n-k)E[\prod_{i=1}^kb_i]
$$

而其中右边的期望公式可以进行化简（详细可以看我的另外一篇博客《组合数学》中的隔板法的问题1。）：

$$
E[\prod_{i=1}^kb_i]=\frac{ n+m-1\choose n+k-1 }{ n+m-1\choose n-1 } 
$$

因此结果为：

$$
\sum_{k=0}^nf(n-k)\frac{ n+m-1\choose n+k-1 }{ n+m-1\choose n-1 } 
$$

总的时间复杂度为$O(n+m+n(\log_2n)^2)$

提供一道题目：SRM763 ProductAndProduct。

**题目2：给定$n$个数，$a_1,\ldots,a_n$，之后我们随机执行$m$次独立操作，每次等概率选择一个下标$i$，并将$a_i$增加$1$。设最后得到的序列为$b_1,\ldots,b_n$，要求计算$E\[\prod_{i=1}^nb_i\]$。这里$1\leq n\leq 10^5,1\leq m\leq 10^9$。**

我们不能用题目1的方式解决这个问题，因为不同结果的概率是不同的。但是我们可以用生成函数来求解。生成函数NB。

我们要求的是：

$$
E[\prod_{i=1}^na_i+b_i]=\frac{m!}{n^m}\sum_{b_1+\ldots+b_n=m}\frac{1}{b_1!\ldots b_n!}\prod_{i=1}^n(a_i+b_i)
$$

它实际是多项式$f(x)=\frac{m!}{n^m}\prod_{i=1}^n\sum_{j\geq 0}\frac{(a_i+j)}{j!}x^j$的$x^m$的系数。下面我们来讨论多项式$f(x)$。考虑$\sum$中的项，通过泰勒展开公式进行化简：

$$
\sum_{j\geq 0}\frac{(a_i+j)}{j!}x^j=\sum_{j\geq 0}\frac{a_i}{j!}x^j+\sum_{j\geq 0}\frac{j}{j!}x^j=a_ie^x+xe^x
$$

带回到多项式中，得到：

$$
f(x)=\frac{m!}{n^m}\prod_{i=1}^n(a_ie^x+xe^x)\\
=\frac{m!}{n^m}e^{nx}\prod_{i=1}^n(a_i+x)
$$

我们可以利用多项式卷积在时间复杂度$O(n(\log_2n)^2)$时间内算出

$$
\prod_{i=1}^n(a_i+x)=\sum_{i=0}^nc_ix^i
$$

接下来我们展开$e^{nx}$：

$$
e^{nx}=\sum_{i\geq 0}\frac{n^i}{i!}x^i
$$

$f$肯定是算不了的，但是我们只需要求$f_m$就够了：

$$
f_m=\frac{m!}{n^m}\sum_{i+j=m}c_i\cdot \frac{n^j}{j!}\\
=\sum_{i+j=m}c_i\cdot \frac{(j+1)\cdot \ldots \cdot m}{n^{i}}
$$

上面这个问题可以在$O(n)$时间复杂度内求解。因此总的时间复杂度为$O(n(\log_2n)^2)$。

提供一道[题目](https://codeforces.com/contest/891/problem/E)。