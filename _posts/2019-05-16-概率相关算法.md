---
categories: algorithm
layout: post
---

- Table
{:toc}

# 期望的状态转移

考虑一个期望问题，我们从0向n出发，每一秒都向前等概率移动距离1，2（如果当前位置与n距离为1，则只能移动距离1）。问从0到n所需时间的期望值。

我们可以用f(i)表示从i到n所需步数的期望，利用期望的状态转移，可以得出：


$$
f(i)=\frac{1}{2}(f(i+1)+f(i+2))+1。
$$


之后我们可以以$O(n)$的时间复杂度计算结果。

# 带原地踏步的状态转移

之前讨论的期望的状态转移是带拓扑序的，因此我们可以很容易计算。现在稍微改变一下，我们现在每秒等概率移动0，1，2距离。这时候我们的函数就出现了自依赖。


$$
f(i)=\frac{1}{3}(f(i)+f(i+1)+f(i+2))+1
$$


我们可以将右边的\frac{1}{3}f(i)移动到左边进行计算。


$$
\frac{2}{3}f(i)=\frac{1}{3}(f(i+1)+f(i+2))+1\\
\Rightarrow f(i)=\frac{1}{2}(f(i+1)+f(i+2))+\frac{3}{2}
$$


之后就是简单的动态规划了。

# 带环的状态转移

修改问题，现在我们每秒有60%的几率向前走一步，40%的几率向后走一步，不允许离开$\[0,n\]$。问移动到n的期望步数。

这时候我们的公式为：



$$
f(i)=0.4f(i-1)+0.6f(i+1)+1
$$



要计算$f(i)$，我们必须先得知$f(i-1)$和$f(i+1)$，而要计算$f(i-1)$和$f(i+1)$，我们必须先得知$f(i)$，这就是先有鸡还是先有蛋的问题，陷入了死循环。

那么是否就无法计算期望呢。我们首先需要相信，期望一定是存在并且是不变的（即期望是唯一的）。之后我们可以推出一组公式：



$$
\left\{ 
\begin{array}{rcl}
f(0) & = & f(1)+1\\
f(1) & = & 0.4f(0)+0.6f(2)+1\\
...\\
f(n-1)&=&0.4f(n-2)+0.6f(n)+1\\
f(n)&=&0
\end{array} 
\right.
$$



对其稍作转换可以得到：

$$
\left\{ 
\begin{array}{lcr}
f(0) - f(1) & = &1\\
f(1) -0.4f(0)-0.6f(2) & = & 1\\
...\\
f(n-1)-0.4f(n-2)-0.6f(n)&=&1\\
f(n)&=&0
\end{array} 
\right.
$$

我们可以把其表示为矩阵和向量的乘积：



$$
\left(
\begin{array}{ccc}
1&-1 &0 & \dots&0 &0&0\\
-0.4&1&-0.6&\ldots&0&0&0\\
\ldots&\ldots&\ldots&\ldots&\ldots&\ldots&\ldots\\
0&0&0&\ldots&-0.4&1&-0.6\\
0&0&0&\ldots&0&0&1\\
\end{array}
\right)
\left(
\begin{array}{ccc}
f(0)\\
f(1)\\
\ldots\\
f(n-1)\\
f(n)
\end{array}
\right)
=
\left(
\begin{array}{ccc}
1\\
1\\
\ldots\\
1\\
0
\end{array}
\right)
$$



我们可以简单记为$Ax=y$。由于之前已经说过期望是唯一不变的，因此矩阵的秩一定为$n+1$，否则就会有多个解。我们可以对矩阵$A$取逆后将式子转换为$x=A^{-1}y$。这样就可以计算出期望序列$x$。



这样我们就能在时间复杂度$O(n^3)$内求解。



# 概率转期望

之前考虑的问题中，讨论概率是没有意义的，因为在足够多的时间过去后，我们一定会达到n，即概率为1。下面我们要讨论既有存在失败情况下游戏的胜利概率。

考虑这样一个问题，我们从1出发，如果到达n我们就获得胜利，游戏结束，如果到达0，我们就失败，游戏结束。问胜利的概率为多少。

如果我们对概率进行转移，我们会发现完全无法解决，比如抵达n的概率，显然与抵达n-1的概率相关，从而可以推出和抵达1的概率有关。那么我们抵达1的概率是多少？100%，还是其它。如果我们认为是100%，就会发现如果我们从2回到1，抵达1的概率就会超出100%，这显然是有问题的。

我们可以定义一个随机变量X，X取的是实验中我们处于位置n的次数。由于X只有两种取值0，1，那么我们可以推出


$$
E(X)=1\cdot p(X=1)+0\cdot p(X=0)=p(X=1)
$$



而$p(X=1)$实际上就是游戏胜利的概率，因此我们可以通过计算$E(X)$得到$p(X=1)$。

而期望的公式怎么建立我们之前就讨论过了，需要注意的是，不可能从$f(0)$和$f(n)$再次进行转移，以及初始时我们处于位置1，因此$f(1)=0.4f(2)+1$。而对于其余值，应该为



$$
f(i)=0.4f(i+1)-0.6f(i-1)
$$

# 随机递增序列

假设有n个未知整数，我们需要$O(C)$的时间复杂度比较一个未知整数和一个已知整数的大小关系，但是要知道某个整数的真实值需要$O(H)$的时间复杂度，而$H$远远大于$C$，可以认为
$$
H\geq C\log_2n
$$
。现在我们想找到这n个整数中最大整数的值。

当然，我们可以直接查询所有未知整数的值，得到最终结果，时间复杂度为$O(nH)$。

我们现在希望能减少时间复杂度。

有一种显然正确的策略，先取第一个数，查出其真实值，作为持有数。之后遍历后面的数，如果这个数比持有数大，将持有数替换为该数。重复这个过程，自然就能找到最大值了，其最坏时间复杂度为$O(n(C+H))=O(nH)$

注意到时间上界是来自于替换的发生，但是事实上，替换不会真的发生n次。如我们对原始的数组进行打乱，我们可以证明一个非常优秀的时间复杂度。

记
$$
f(i)
$$
表示已经检查过$i$个数，后面检查$n-i$个数会发生替换操作次数的期望。那么考虑一个新的数$x$，只有当$x$比我们之前检查过的$i$个数都大的情况下，才会发生替换。因此可以推出期望公式：



$$
f(i)=\frac{1}{i+1}(f(i+1)+1)+\frac{i}{i+1}f(i+1)\\
=f(i+1)+\frac{1}{i+1}
$$



我们要求的是$f(0)$，即检查$n$个数发生的替换总次数的期望，可以推出：


$$
f(0)=f(1)+\frac{1}{1}\\
=f(2)+\frac{1}{1}+\frac{1}{2}\\
\ldots\\
=f(n)+\sum_{i=1}^n\frac{1}{i}\\
=\sum_{i=1}^n\frac{1}{i}\\
\approx \ln n
$$


因此期望的时间复杂度为
$$
O(nC+H\ln n)
$$
。

这是非常优秀的时间复杂度。

## 例子1

可以考虑这样一个问题，我们现在有1000份简历，我们需要面试1000个人，并从中找出能力最优秀的候选人。

面试能帮助我们了解应聘人是否比我们已经招募的那个人（通过了试用期）更加优秀。我们可以邀请一个人参加试用，在试用期结束后，我们就能得到这个人的真实能力。

由于岗位有限，同时最多只能有一个人处于试用期。面试一个人，需要一个小时，试用期则长达1个月。问我们最少需要多少时间才能找到最优秀的人。

假如我们每个人都邀请参加试用，那么会需要1000个月，要面到大家都退休。或者我们使用贪心策略，却不保证随机（比如HR按自己的观感将候选人从差到优进行排序），也可能会需要1000个月。

现在我们随机打乱所有的简历，并采用贪心策略，那么我们的所需的期望时间仅仅为1000个小时加上10个月，估摸是一年内可以结束。

# 一些期望计算问题

**问题1：给定n个石头，其处于一条直线上，从左到右的下标分别为$x_1,x_2,\ldots,x_n$，满足$x_1<x_2<\ldots<x_n$。现在我们每次要等概率挑选一个石头（不能选最靠右的那个），将这个石头右移直到碰撞到右边第一个石头，如果碰撞了，那么两个石头就合成了一块石头。重复上面的操作$n-1$次，问所有石头移动的总距离的期望是多少？**

考虑到期望的线性性质，我们可以独立计算第$i$个石头被选择后移动的总距离$d_i$，之后我们要求的就是$E(\sum_{i=1}^{n-1}d_i)=\sum_{i=1}^{n-1}E(d_i)$。考虑第$i$个石头，它停在$x_j$处的概率为$\frac{(j-i-1)!}{(j-i+1)!}$，特殊的停在$x_n$处的概率为$\frac{1}{n-i}$。利用这些性质我们就可以独立求出$E(d_i)$，加总就好了，这样我们的时间复杂度为$O(n^2)$。

但是这个问题实际上并不要求我们算出所有石头移动距离的期望，它要求的只是总期望而已。我们可以拆解$d_i$，记录$t_{i,j}$表示石头$i$在$x_{j-1}$与$x_j$之间通过距离的期望，那么$d_i=\sum_{j=i+1}^nt_{i,j}$。而我们知道$t_{i,j}$仅可能取两个值：$0$或$x_j-x_{j-1}$，其中$P(t_{i,j}=x_j-x_{j-1})=\frac{1}{j-i}$。因此我们重写我们要求的总距离的期望，可以得到：

$$
E(\sum_{i=1}^{n-1}d_i)\\
=E(\sum_{i=1}^{n-1}\sum_{j=i+1}^nt_{i,j})\\
=E(\sum_{j=2}^n\sum_{i=1}^{j-1}t_{i,j})\\
=\sum_{j=2}^n\sum_{i=1}^{j-1}E(t_{i,j})\\
=\sum_{j=2}^n\sum_{i=1}^{j-1}\frac{x_j-x_{j-1}}{j-i}\\
=\sum_{j=2}^n(x_j-x_{j-1})\sum_{i=1}^{j-1}\frac{1}{j-i}\\
=\sum_{j=2}^n(x_j-x_{j-1})\sum_{i=1}^{j-1}\frac{1}{i}\\
$$

注意到右边的$\sum_{i=1}^{j-1}\frac{1}{i}$我们可以线性时间内预处理出来，因此总的时间复杂度可以优化到$O(n)$。